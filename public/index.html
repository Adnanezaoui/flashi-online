<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POLO</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body{margin:0;font-family:sans-serif;background:#0b2c35;color:white;text-align:center}
button{padding:10px 20px;margin:5px;border:none;border-radius:20px;cursor:pointer}
canvas{border-radius:20px;border:4px solid #00e0ff;margin:10px}
#gamePage{display:none}
#results{display:none}
table{margin:auto;border-collapse:collapse;width:80%;background:white;color:black}
th,td{border:1px solid black;padding:8px}
</style>
</head>
<body>

<div id="loginPage">
<h1>ðŸ”¥ POLO ðŸ”¥</h1>
<button onclick="showPlayer()">Ø¯Ø®ÙˆÙ„ Ù„Ø§Ø¹Ø¨</button>
<button onclick="showAdmin()">Ø¯Ø®ÙˆÙ„ Ø£Ø¯Ù…Ù†</button>

<div id="playerBox" style="display:none">
<input id="playerName" placeholder="Ø§Ø³Ù…Ùƒ">
<input id="playerPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<button onclick="join(false)">Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="adminBox" style="display:none">
<input id="adminName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù†">
<input id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<button onclick="join(true)">Ø¯Ø®ÙˆÙ„</button>
</div>
</div>

<div id="gamePage">
<h2 id="roundTitle"></h2>
<div id="adminControls" style="display:none">
<button onclick="startGame()">â–¶ Start</button>
</div>

<canvas id="left" width="400" height="300"></canvas>
<canvas id="right" width="400" height="300"></canvas>

<h3>Players</h3>
<ul id="playersList"></ul>

<h3>Your Score: <span id="myScore">0</span></h3>

<div id="results">
<h2>Round Results</h2>
<table>
<thead><tr><th>Rank</th><th>Name</th><th>Total</th></tr></thead>
<tbody id="resultsBody"></tbody>
</table>
</div>
</div>

<script>
const socket = io();
let isAdmin=false;
let myId=null;
let differences=[];
let myScore=0;

function showPlayer(){document.getElementById("playerBox").style.display="block"}
function showAdmin(){document.getElementById("adminBox").style.display="block"}

function join(admin){
    if(admin){
        if(document.getElementById("adminPass").value!=="ADMINPOLO") return;
        isAdmin=true;
        socket.emit("join",{name:adminName.value,isAdmin:true});
        document.getElementById("adminControls").style.display="block";
    } else {
        if(document.getElementById("playerPass").value!=="POLO FAMILY") return;
        socket.emit("join",{name:playerName.value,isAdmin:false});
    }
    document.getElementById("loginPage").style.display="none";
    document.getElementById("gamePage").style.display="block";
}

socket.on("playersUpdate",players=>{
    const ul=document.getElementById("playersList");
    ul.innerHTML="";
    players.forEach(p=>{
        const li=document.createElement("li");
        li.innerText=p.name+" - "+p.totalScore;
        ul.appendChild(li);
    });
});

socket.on("roundStarted",data=>{
    document.getElementById("results").style.display="none";
    document.getElementById("roundTitle").innerText="Round "+data.round;
    myScore=0;
    document.getElementById("myScore").innerText=0;
    loadImages(data.seed);
});

socket.on("roundEnded",leaderboard=>{
    document.getElementById("results").style.display="block";
    const body=document.getElementById("resultsBody");
    body.innerHTML="";
    leaderboard.forEach((p,i)=>{
        body.innerHTML+=`<tr><td>${i+1}</td><td>${p.name}</td><td>${p.totalScore}</td></tr>`;
    });
});

function startGame(){socket.emit("startGame")}

const left=document.getElementById("left");
const right=document.getElementById("right");
const lctx=left.getContext("2d");
const rctx=right.getContext("2d");

function loadImages(seed){
    const img=new Image();
    img.crossOrigin="anonymous";
    img.src="https://source.unsplash.com/600x400/?nature&sig="+seed;

    img.onload=()=>{
        lctx.drawImage(img,0,0,400,300);
        rctx.drawImage(img,0,0,400,300);
        generateDifferences();
    }
}

function generateDifferences(){
    differences=[];
    for(let i=0;i<5;i++){
        let x=Math.random()*350+20;
        let y=Math.random()*250+20;
        differences.push({x,y,found:false});
        rctx.fillStyle="rgba(255,0,0,0.4)";
        rctx.beginPath();
        rctx.arc(x,y,15,0,Math.PI*2);
        rctx.fill();
    }
}

right.addEventListener("click",e=>{
    const rect=right.getBoundingClientRect();
    const x=e.clientX-rect.left;
    const y=e.clientY-rect.top;

    let hit=false;
    differences.forEach(d=>{
        if(!d.found){
            const dist=Math.hypot(x-d.x,y-d.y);
            if(dist<20){
                d.found=true;
                hit=true;
                rctx.strokeStyle="lime";
                rctx.beginPath();
                rctx.arc(d.x,d.y,20,0,Math.PI*2);
                rctx.stroke();
                myScore++;
                document.getElementById("myScore").innerText=myScore;
                socket.emit("scorePoint");
            }
        }
    });

    if(!hit){
        rctx.strokeStyle="red";
        rctx.beginPath();
        rctx.arc(x,y,20,0,Math.PI*2);
        rctx.stroke();
    }
});
</script>

</body>
</html>
